{% extends "base.html" %}

{% block title %}Práctica de Escritura - {{ lesson.title }}{% endblock %}

{% block content %}
<div class="container my-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('lesson_detail', lesson_id=lesson.id) }}">{{ lesson.title }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Práctica</li>
        </ol>
    </nav>

    <div class="card mb-4">
        <div class="card-header {% if version == 'kids' %}bg-warning{% else %}bg-primary{% endif %} text-white">
            <h2 class="mb-0">
                <i class="fas fa-pen-fancy me-2"></i> Práctica de Escritura - {{ lesson.title }}
            </h2>
        </div>
        <div class="card-body">
            <div class="instruction-section bg-light p-3 rounded mb-4">
                <h4><i class="fas fa-info-circle me-2"></i> Instrucciones</h4>
                <p class="mb-0">Usa las herramientas de abajo para practicar la escritura. Selecciona una letra o palabra guía y traza sobre ella con el mouse o con tu dedo.</p>
            </div>
            
            <div class="paint-container border rounded">
                <div class="paint-header bg-light p-3">
                    <span class="fw-bold">Herramientas de escritura</span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" id="toggleGuides">
                            <i class="fas fa-layer-group"></i> Guías
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="clearAll">
                            <i class="fas fa-broom"></i> Limpiar
                        </button>
                    </div>
                </div>
                
                <div class="tools-panel p-3 bg-light border-bottom">
                    <div class="tool-group mb-2 mb-md-0">
                        <button class="btn btn-sm {% if version == 'kids' %}btn-warning{% else %}btn-primary{% endif %} me-2 active" id="brushTool" title="Pincel">
                            <i class="fas fa-paint-brush"></i> Pincel
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="eraserTool" title="Borrador">
                            <i class="fas fa-eraser"></i> Borrador
                        </button>
                    </div>
                    
                    <div class="tool-group mb-2 mb-md-0">
                        <span class="me-2">Tamaño:</span>
                        <input type="range" id="brushSize" min="1" max="30" value="5" class="form-range" style="width: 100px;">
                    </div>
                    
                    <div class="tool-group">
                        <div class="color-picker">
                            <div class="color-option active" style="background-color: #000000;" data-color="#000000" title="Negro"></div>
                            <div class="color-option" style="background-color: #e74a3b;" data-color="#e74a3b" title="Rojo"></div>
                            <div class="color-option" style="background-color: #4e73df;" data-color="#4e73df" title="Azul"></div>
                            <div class="color-option" style="background-color: #1cc88a;" data-color="#1cc88a" title="Verde"></div>
                        </div>
                    </div>
                </div>
                
                <div class="canvas-container position-relative" style="height: 400px;">
                    <canvas id="paintCanvas" class="w-100 h-100"></canvas>
                    <canvas id="guideOverlay" class="guide-overlay position-absolute top-0 start-0 w-100 h-100"></canvas>
                </div>
                
                <div class="word-guides p-3 bg-light">
                    <span class="fw-bold me-2">Practicar:</span>
                    <button class="btn btn-sm {% if version == 'kids' %}btn-outline-warning{% else %}btn-outline-primary{% endif %} me-2 mb-2" data-word="A">Letra A</button>
                    <button class="btn btn-sm {% if version == 'kids' %}btn-outline-warning{% else %}btn-outline-primary{% endif %} me-2 mb-2" data-word="B">Letra B</button>
                    <button class="btn btn-sm {% if version == 'kids' %}btn-outline-warning{% else %}btn-outline-primary{% endif %} me-2 mb-2" data-word="C">Letra C</button>
                    <button class="btn btn-sm {% if version == 'kids' %}btn-outline-warning{% else %}btn-outline-primary{% endif %} me-2 mb-2" data-word="M">Letra M</button>
                    <button class="btn btn-sm {% if version == 'kids' %}btn-outline-warning{% else %}btn-outline-primary{% endif %} me-2 mb-2" data-word="Hola">Palabra: Hola</button>
                    <button class="btn btn-sm {% if version == 'kids' %}btn-outline-warning{% else %}btn-outline-primary{% endif %} me-2 mb-2" data-word="Mama">Palabra: Mamá</button>
                </div>
            </div>
            
            <div class="action-buttons mt-4">
                <button class="btn {% if version == 'kids' %}btn-warning{% else %}btn-primary{% endif %}" id="savePractice">
                    <i class="fas fa-save me-1"></i> Guardar Práctica
                </button>
                <button class="btn btn-outline-secondary ms-2" id="resetPractice">
                    <i class="fas fa-redo me-1"></i> Empezar de nuevo
                </button>
                <a href="{{ url_for('lesson_detail', lesson_id=lesson.id) }}" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-arrow-left me-1"></i> Volver a la lección
                </a>
                <a href="{{ url_for('quiz', lesson_id=lesson.id) }}" class="btn btn-success ms-auto">
                    Realizar cuestionario <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .paint-container {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .tools-panel {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
    }
    
    .tool-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .color-picker {
        display: flex;
        gap: 8px;
    }
    
    .color-option {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: transform 0.2s;
    }
    
    .color-option:hover {
        transform: scale(1.2);
    }
    
    .color-option.active {
        border-color: #333;
        transform: scale(1.2);
    }
    
    .guide-overlay {
        pointer-events: none;
        opacity: 0.2;
        z-index: 5;
    }
    
    .word-guides {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
    }
    
    #paintCanvas {
        background: white;
        cursor: crosshair;
        touch-action: none;
    }
    
    /* Estilos para modo niños */
    body.version-kids .paint-container {
        border-color: #ffc107;
    }
    
    body.version-kids .paint-header {
        background: #fff3cd !important;
        color: #856404;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.getElementById('paintCanvas');
        const guideCanvas = document.getElementById('guideOverlay');
        const ctx = canvas.getContext('2d');
        const guideCtx = guideCanvas.getContext('2d');
        const container = document.querySelector('.canvas-container');
        
        // Ajustar tamaño de los canvas al contenedor
        function resizeCanvases() {
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            canvas.width = width;
            canvas.height = height;
            guideCanvas.width = width;
            guideCanvas.height = height;
            
            // Redibujar guías si estaban activas
            if (guidesVisible) {
                drawGuides(currentWord);
            }
        }
        
        // Variables de estado
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentColor = '#000000';
        let brushSize = 5;
        let currentTool = 'brush';
        let guidesVisible = true;
        let currentWord = 'A';
        
        // Inicializar
        resizeCanvases();
        window.addEventListener('resize', resizeCanvases);
        drawGuides(currentWord);
        
        // Funciones de dibujo
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = getPosition(e);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const [x, y] = getPosition(e);
            
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = brushSize;
            ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : currentColor;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            [lastX, lastY] = [x, y];
        }
        
        function stopDrawing() {
            isDrawing = false;
        }
        
        function getPosition(e) {
            let x, y;
            const rect = canvas.getBoundingClientRect();
            
            if (e.type.includes('touch')) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }
            
            return [x, y];
        }
        
        // Dibujar guías de escritura
        function drawGuides(word) {
            guideCtx.clearRect(0, 0, guideCanvas.width, guideCanvas.height);
            
            if (!guidesVisible) return;
            
            guideCtx.strokeStyle = '#4e73df';
            guideCtx.lineWidth = 1;
            guideCtx.setLineDash([5, 5]);
            
            // Líneas de base para escritura
            const centerY = guideCanvas.height / 2;
            guideCtx.beginPath();
            guideCtx.moveTo(0, centerY);
            guideCtx.lineTo(guideCanvas.width, centerY);
            guideCtx.stroke();
            
            guideCtx.beginPath();
            guideCtx.moveTo(0, centerY - 40);
            guideCtx.lineTo(guideCanvas.width, centerY - 40);
            guideCtx.stroke();
            
            guideCtx.beginPath();
            guideCtx.moveTo(0, centerY + 40);
            guideCtx.lineTo(guideCanvas.width, centerY + 40);
            guideCtx.stroke();
            
            // Texto guía
            guideCtx.fillStyle = 'rgba(78, 115, 223, 0.2)';
            guideCtx.font = 'bold 120px Arial';
            guideCtx.textAlign = 'center';
            guideCtx.textBaseline = 'middle';
            guideCtx.fillText(word, guideCanvas.width / 2, centerY);
            
            guideCtx.setLineDash([]);
        }
        
        // Limpiar el canvas
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        // Event listeners para herramientas
        document.getElementById('brushTool').addEventListener('click', function() {
            currentTool = 'brush';
            this.classList.add('active');
            this.classList.remove('btn-outline-secondary');
            this.classList.add('{% if version == "kids" %}btn-warning{% else %}btn-primary{% endif %}');
            
            document.getElementById('eraserTool').classList.remove('active');
            document.getElementById('eraserTool').classList.remove('{% if version == "kids" %}btn-warning{% else %}btn-primary{% endif %}');
            document.getElementById('eraserTool').classList.add('btn-outline-secondary');
        });
        
        document.getElementById('eraserTool').addEventListener('click', function() {
            currentTool = 'eraser';
            this.classList.add('active');
            this.classList.remove('btn-outline-secondary');
            this.classList.add('{% if version == "kids" %}btn-warning{% else %}btn-primary{% endif %}');
            
            document.getElementById('brushTool').classList.remove('active');
            document.getElementById('brushTool').classList.remove('{% if version == "kids" %}btn-warning{% else %}btn-primary{% endif %}');
            document.getElementById('brushTool').classList.add('btn-outline-secondary');
        });
        
        document.getElementById('clearAll').addEventListener('click', clearCanvas);
        
        document.getElementById('resetPractice').addEventListener('click', function() {
            if (confirm('¿Estás seguro de que quieres borrar todo y empezar de nuevo?')) {
                clearCanvas();
                drawGuides(currentWord);
            }
        });
        
        // Event listeners para colores
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                currentColor = this.getAttribute('data-color');
            });
        });
        
        // Control de tamaño de pincel
        document.getElementById('brushSize').addEventListener('input', function() {
            brushSize = this.value;
        });
        
        // Botones de palabras guía
        document.querySelectorAll('.word-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentWord = this.getAttribute('data-word');
                drawGuides(currentWord);
                
                // Resaltar botón seleccionado
                document.querySelectorAll('.word-btn').forEach(b => {
                    b.classList.remove('{% if version == "kids" %}btn-warning{% else %}btn-primary{% endif %}');
                    b.classList.add('{% if version == "kids" %}btn-outline-warning{% else %}btn-outline-primary{% endif %}');
                });
                this.classList.remove('{% if version == "kids" %}btn-outline-warning{% else %}btn-outline-primary{% endif %}');
                this.classList.add('{% if version == "kids" %}btn-warning{% else %}btn-primary{% endif %}');
            });
        });
        
        // Toggle guías
        document.getElementById('toggleGuides').addEventListener('click', function() {
            guidesVisible = !guidesVisible;
            drawGuides(currentWord);
            this.innerHTML = guidesVisible ? 
                '<i class="fas fa-layer-group"></i> Ocultar Guías' : 
                '<i class="fas fa-layer-group"></i> Mostrar Guías';
        });
        
        // Guardar práctica
        document.getElementById('savePractice').addEventListener('click', function() {
            // Convertir canvas a imagen
            const dataURL = canvas.toDataURL('image/png');
            
            // Crear un enlace de descarga
            const link = document.createElement('a');
            link.download = 'practica-escritura-' + new Date().toISOString().slice(0, 10) + '.png';
            link.href = dataURL;
            link.click();
            
            // Mostrar mensaje de éxito
            alert('¡Práctica guardada correctamente!');
        });
        
        // Event listeners para dibujar
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        // Soporte para dispositivos táctiles
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            startDrawing(e);
        });
        
        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            draw(e);
        });
        
        canvas.addEventListener('touchend', function(e) {
            e.preventDefault();
            stopDrawing();
        });
    });
</script>
{% endblock %}
